name: Azure Static Web Apps CI/CD

on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened, closed]
    branches:
      - main

jobs:
  build_and_deploy_job:
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.action != 'closed')
    runs-on: ubuntu-latest
    env:
      # allow npm to install with legacy peer deps in case any action runs `npm ci`
      NPM_CONFIG_LEGACY_PEER_DEPS: 'true'
    name: Build and Deploy Job
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: true
          lfs: false
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install pnpm
        run: npm install -g pnpm

      - name: Show package.json (diagnostic)
        run: |
          echo "--- package.json ---"
          cat package.json || true
          echo "--- git HEAD and package.json from git ---"
          git rev-parse --short HEAD || true
          git show HEAD:package.json || true
          echo "--- git status ---"
          git status --porcelain || true
          echo "--- repo root listing ---"
          ls -la || true

      - name: Ensure npm will use legacy peer deps (diagnostic)
        run: |
          npm config get legacy-peer-deps || true
          npm config set legacy-peer-deps true
          echo "npm legacy-peer-deps set to:" $(npm config get legacy-peer-deps)

      - name: Install dependencies (clean)
        run: |
          # remove any lockfiles that could force npm ci or conflicting installs
          rm -f package-lock.json pnpm-lock.yaml yarn.lock
          rm -rf node_modules
          # Try npm install with legacy-peer-deps first to avoid ERESOLVE from npm ci
          npm ci --legacy-peer-deps || npm install --legacy-peer-deps || true

          # Diagnostic: show if uploadthing or @uploadthing/react are present after npm install
          echo "--- npm ls for uploadthing packages ---"
          npm ls uploadthing @uploadthing/react --all || true

          # Then run pnpm install to get expected pnpm environment (if you prefer pnpm tooling)
          pnpm install
      
      - name: Build Next.js app
        run: npm run build
        env:
          NEXT_PUBLIC_APPWRITE_ENDPOINT: ${{ secrets.NEXT_PUBLIC_APPWRITE_ENDPOINT }}
          NEXT_PUBLIC_APPWRITE_PROJECT_ID: ${{ secrets.NEXT_PUBLIC_APPWRITE_PROJECT_ID }}
      
      - name: Build And Deploy
        id: builddeploy
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_RED_OCEAN_04ACD9B1E }}
          repo_token: ${{ secrets.GITHUB_TOKEN }} # Used for Github integrations (i.e. PR comments)
          action: "upload"
          app_location: "/" # App source code path
          api_location: "" # Api source code path - optional
          # Let the action build the app instead of requiring a pre-built static `out` folder.
          # This is needed because the project uses the Next.js App Router and cannot be
          # fully exported with `next export`.
          # If you prefer to pre-build locally, set skip_app_build: true and ensure `out` exists.
          output_location: "out" # Built app content directory - optional
          skip_app_build: false

  close_pull_request_job:
    if: github.event_name == 'pull_request' && github.event.action == 'closed'
    runs-on: ubuntu-latest
    name: Close Pull Request Job
    steps:
      - name: Close Pull Request
        id: closepullrequest
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_RED_OCEAN_04ACD9B1E }}
          action: "close"
